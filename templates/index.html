<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ metadata.name }} {{ metadata.version }} - Web Interface</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .main-content {
        padding: 40px;
      }

      .upload-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 40px;
      }

      .upload-box {
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-box:hover {
        border-color: #764ba2;
        background: #f0f4ff;
        transform: translateY(-2px);
      }

      .upload-box.dragover {
        border-color: #52c41a;
        background: #f6ffed;
      }

      .upload-icon {
        font-size: 3em;
        color: #667eea;
        margin-bottom: 20px;
      }

      .upload-text {
        font-size: 1.1em;
        color: #555;
        margin-bottom: 20px;
      }

      .file-input {
        display: none;
      }

      .files-container {
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
      }

      .file-management-section {
        background: #f8f9ff;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .file-management-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .file-management-header h3 {
        color: #333;
        margin: 0;
      }

      .clear-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .clear-btn {
        background: #ff4d4f;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s ease;
        font-size: 0.9em;
      }

      .clear-btn:hover {
        background: #d32f2f;
      }

      .clear-btn.clear-all {
        background: #ff7875;
      }

      .clear-btn.clear-all:hover {
        background: #ff4d4f;
      }

      .files-display {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .files-column h4 {
        color: #555;
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        text-align: center;
      }

      .file-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .file-item {
        background: white;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .file-preview {
        width: 50px;
        height: 50px;
        border-radius: 5px;
        object-fit: cover;
        margin-right: 10px;
      }

      .file-info {
        flex: 1;
      }

      .file-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 2px;
      }

      .file-type {
        font-size: 0.9em;
        color: #666;
      }

      /* Video preview styles */
      .video-preview-container {
        position: relative;
        width: 50px;
        height: 50px;
        border-radius: 5px;
        overflow: hidden;
        background: #000;
      }

      .file-preview-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 5px;
      }

      .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .video-preview-container:hover .video-overlay {
        opacity: 1;
      }

      .video-icon {
        color: white;
        font-size: 1.2em;
      }

      .play-btn {
        background: #52c41a;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
        margin-left: 5px;
        transition: background 0.3s ease;
      }

      .play-btn:hover {
        background: #389e0d;
      }

      /* Result video styles */
      .result-video-container {
        width: 100%;
        max-width: 400px;
        height: 250px;
        margin: 10px 0;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
      }

      .result-video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background: #000;
      }

      .video-play-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px;
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        font-size: 1.5em;
      }

      .result-video-container:hover .video-play-overlay {
        opacity: 1;
      }

      .play-result-btn {
        background: #722ed1;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
        transition: background 0.3s ease;
      }

      .play-result-btn:hover {
        background: #531dab;
      }

      /* Video modal styles */
      .video-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
      }

      .video-modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 90vw;
        max-height: 90vh;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
      }

      .video-modal video {
        width: 100%;
        height: auto;
        max-height: 90vh;
      }

      .video-modal-close {
        position: absolute;
        top: 15px;
        right: 25px;
        color: white;
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
        background: rgba(0, 0, 0, 0.5);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
      }

      .video-modal-close:hover {
        background: rgba(0, 0, 0, 0.8);
      }

      .file-actions {
        margin-left: 10px;
      }

      .remove-btn {
        background: #ff4d4f;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
      }

      .remove-btn:hover {
        background: #d32f2f;
      }

      .settings-section {
        background: #f8f9ff;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
      }

      .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .setting-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .setting-label {
        font-weight: 500;
        color: #333;
      }

      .toggle-switch {
        position: relative;
        width: 60px;
        height: 30px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 30px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: #667eea;
      }

      input:checked + .slider:before {
        transform: translateX(30px);
      }

      .process-section {
        text-align: center;
        margin-bottom: 30px;
      }

      .process-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.2em;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .process-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
      }

      .process-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .status-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 5px solid #667eea;
      }

      .status-text {
        font-weight: 500;
        color: #333;
        margin-bottom: 10px;
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        background: #f0f0f0;
        border-radius: 5px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.3s ease;
      }

      .video-progress-info {
        margin: 10px 0;
        padding: 12px;
        background: #f0f4ff;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .progress-details {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        font-size: 0.9em;
      }

      .progress-details span {
        padding: 6px 12px;
        background: white;
        border-radius: 6px;
        text-align: center;
        font-family: monospace;
        color: #333;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 768px) {
        .progress-details {
          grid-template-columns: 1fr;
          gap: 8px;
        }
      }

      .processing-details {
        margin-top: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
        overflow: hidden;
      }

      .details-header {
        padding: 12px 15px;
        background: #f5f5f5;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.2s ease;
        user-select: none;
      }

      .details-header:hover {
        background: #eeeeee;
      }

      .details-header span:first-child {
        font-family: monospace;
        font-size: 12px;
        margin-right: 8px;
        transition: transform 0.2s ease;
      }

      .details-header.collapsed span:first-child {
        transform: rotate(-90deg);
      }

      .log-count {
        font-size: 0.85em;
        color: #666;
        font-weight: normal;
      }

      .details-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .details-content.expanded {
        max-height: 300px;
        overflow-y: auto;
      }

      .log-container {
        padding: 15px;
        background: white;
        font-family: "Consolas", "Monaco", "Courier New", monospace;
        font-size: 0.85em;
        line-height: 1.4;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 3px 6px;
        border-radius: 3px;
        word-wrap: break-word;
        white-space: pre-wrap;
      }

      .log-entry:hover {
        background: #f0f4ff;
      }

      .log-entry:last-child {
        margin-bottom: 0;
        background: #e6f7ff;
        border-left: 3px solid #1890ff;
        font-weight: 500;
      }

      .log-entry.error {
        background: #fff2f0;
        border-left: 3px solid #ff4d4f;
        color: #a8071a;
      }

      .log-entry.success {
        background: #f6ffed;
        border-left: 3px solid #52c41a;
        color: #389e0d;
      }

      .log-entry.warning {
        background: #fffbe6;
        border-left: 3px solid #faad14;
        color: #d46b08;
      }

      .result-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 20px;
        text-align: center;
      }

      .batch-results {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin: 20px 0;
      }

      .result-item {
        background: #f8f9ff;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
      }

      .result-preview {
        margin: 15px 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .result-image {
        max-width: 100%;
        max-height: 600px;
        width: auto;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .result-image:hover {
        transform: scale(1.02);
      }

      .result-info {
        margin-bottom: 10px;
        font-size: 0.9em;
        color: #666;
      }

      .download-individual {
        background: #52c41a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 10px;
      }

      .download-individual:hover {
        background: #389e0d;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Fullscreen image modal */
      .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        cursor: pointer;
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 95%;
        max-height: 95%;
        object-fit: contain;
      }

      .close-modal {
        position: absolute;
        top: 20px;
        right: 35px;
        color: white;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
      }

      .close-modal:hover {
        color: #ccc;
      }

      .download-section {
        text-align: center;
      }

      .download-btn {
        background: #52c41a;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 1.1em;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(82, 196, 26, 0.3);
      }

      .download-btn:hover {
        background: #389e0d;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(82, 196, 26, 0.4);
      }

      .error {
        color: #ff4d4f;
        background: #fff2f0;
        border: 1px solid #ffccc7;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }

      @media (max-width: 768px) {
        .upload-section {
          grid-template-columns: 1fr;
        }

        .settings-grid {
          grid-template-columns: 1fr;
        }

        .main-content {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>{{ metadata.name }}</h1>
        <p>{{ metadata.version }} - Web Interface</p>
      </div>

      <div class="main-content">
        <!-- Upload Section -->
        <div class="upload-section">
          <div
            class="upload-box"
            onclick="document.getElementById('source-input').click()"
          >
            <div class="upload-icon">üë§</div>
            <div class="upload-text">
              Select Source Faces (Multiple allowed)
            </div>
            <input
              type="file"
              id="source-input"
              class="file-input"
              accept="image/*"
              multiple
              onchange="uploadFiles(this, 'source')"
            />
            <div id="source-files" class="files-container"></div>
          </div>

          <div
            class="upload-box"
            onclick="document.getElementById('target-input').click()"
          >
            <div class="upload-icon">üé•</div>
            <div class="upload-text">
              Select Target Videos/Images (Multiple allowed)
            </div>
            <input
              type="file"
              id="target-input"
              class="file-input"
              accept="image/*,video/*"
              multiple
              onchange="uploadFiles(this, 'target')"
            />
            <div id="target-files" class="files-container"></div>
          </div>
        </div>

        <!-- File Management Section -->
        <div class="file-management-section">
          <div class="file-management-header">
            <h3>Uploaded Files</h3>
            <div class="clear-buttons">
              <button class="clear-btn" onclick="clearSourceFiles()">
                Clear Sources
              </button>
              <button class="clear-btn" onclick="clearTargetFiles()">
                Clear Targets
              </button>
              <button class="clear-btn clear-all" onclick="clearAllFiles()">
                Clear All
              </button>
            </div>
          </div>
          <div class="files-display">
            <div class="files-column">
              <h4>Source Files (<span id="source-count">0</span>)</h4>
              <div id="source-list" class="file-list"></div>
            </div>
            <div class="files-column">
              <h4>Target Files (<span id="target-count">0</span>)</h4>
              <div id="target-list" class="file-list"></div>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div class="settings-section">
          <h3 style="margin-bottom: 20px; color: #333">Processing Settings</h3>
          <div class="settings-grid">
            <div class="setting-item">
              <span class="setting-label">Keep FPS</span>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="keep_fps"
                  checked
                  onchange="updateSetting('keep_fps', this.checked)"
                />
                <span class="slider"></span>
              </label>
            </div>
            <div class="setting-item">
              <span class="setting-label">Keep Audio</span>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="keep_audio"
                  checked
                  onchange="updateSetting('keep_audio', this.checked)"
                />
                <span class="slider"></span>
              </label>
            </div>
            <div class="setting-item">
              <span class="setting-label">Keep Frames</span>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="keep_frames"
                  onchange="updateSetting('keep_frames', this.checked)"
                />
                <span class="slider"></span>
              </label>
            </div>
            <div class="setting-item">
              <span class="setting-label">Many Faces</span>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="many_faces"
                  onchange="updateSetting('many_faces', this.checked)"
                />
                <span class="slider"></span>
              </label>
            </div>
            <div class="setting-item">
              <span class="setting-label">NSFW Filter</span>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="nsfw_filter"
                  onchange="updateSetting('nsfw_filter', this.checked)"
                />
                <span class="slider"></span>
              </label>
            </div>
            <div class="setting-item">
              <span class="setting-label">Face Enhancer</span>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="face_enhancer"
                  checked
                  onchange="updateSetting('face_enhancer', this.checked)"
                />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Process Section -->
        <div class="process-section">
          <button
            class="process-btn"
            id="process-btn"
            onclick="startProcessing()"
          >
            Start Processing
          </button>
        </div>

        <!-- Status Section -->
        <div class="status-section">
          <div class="status-text" id="status-text">Ready to process</div>
          <div
            class="video-progress-info"
            id="video-progress-info"
            style="display: none"
          >
            <div class="progress-details">
              <span id="frame-info"></span>
              <span id="time-info"></span>
              <span id="speed-info"></span>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>

          <!-- Detailed Processing Logs -->
          <div
            class="processing-details"
            id="processing-details"
            style="display: none"
          >
            <div class="details-header" onclick="toggleProcessingDetails()">
              <span id="details-toggle">‚ñº</span>
              <span>Processing Details</span>
              <span class="log-count" id="log-count">(0 logs)</span>
            </div>
            <div class="details-content" id="details-content">
              <div class="log-container" id="log-container">
                <div class="log-entry">
                  Click "Start Processing" to see detailed logs...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Batch Results Section -->
        <div class="result-section" id="result-section" style="display: none">
          <h3 style="margin-bottom: 20px; color: #333; text-align: center">
            Processing Results
          </h3>
          <div id="batch-results" class="batch-results"></div>
          <div class="download-section" style="margin-top: 20px">
            <button class="download-btn" onclick="downloadAllResults()">
              üì¶ Download All Results (ZIP)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Full-screen image modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
      <span class="close-modal" onclick="closeImageModal()">&times;</span>
      <img class="modal-content" id="modalImage" />
    </div>

    <!-- Full-screen video modal -->
    <div id="videoModal" class="video-modal" onclick="closeVideoModal()">
      <span class="video-modal-close" onclick="closeVideoModal()">&times;</span>
      <div class="video-modal-content">
        <video id="modalVideo" controls autoplay>
          <source id="modalVideoSource" src="" type="video/mp4" />
          Your browser does not support the video tag.
        </video>
      </div>
    </div>

    <script>
      let uploadedSources = [];
      let uploadedTargets = [];

      function uploadFiles(input, type) {
        const files = input.files;
        if (!files || files.length === 0) return;

        const formData = new FormData();
        for (let file of files) {
          formData.append("file", file);
        }
        formData.append("type", type);

        const statusDiv = document.getElementById(type + "-files");
        statusDiv.innerHTML = '<div style="color: #667eea;">Uploading...</div>';

        fetch("/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              statusDiv.innerHTML = `<div style="color: #52c41a;">‚úì ${data.files.length} file(s) uploaded</div>`;

              // Update global lists
              if (type === "source") {
                uploadedSources = [...uploadedSources, ...data.files];
              } else {
                uploadedTargets = [...uploadedTargets, ...data.files];
                // Check if any target files are videos and disable face enhancer
                checkAndUpdateFaceEnhancer();
              }

              updateFileDisplay();
              updateProcessButton();
            } else {
              statusDiv.innerHTML = `<div class="error">${data.error}</div>`;
            }
          })
          .catch((error) => {
            statusDiv.innerHTML = `<div class="error">Upload failed: ${error.message}</div>`;
          });
      }

      function updateFileDisplay() {
        // Update source files display
        const sourceList = document.getElementById("source-list");
        const sourceCount = document.getElementById("source-count");
        sourceCount.textContent = uploadedSources.length;

        sourceList.innerHTML = uploadedSources
          .map(
            (file) => `
          <div class="file-item" data-file-id="${file.id}">
            ${
              file.type === "video"
                ? `<div class="file-preview video-preview-container" onclick="openVideoModal('/preview/${file.filename}')">
                     <video class="file-preview-video" muted preload="metadata">
                       <source src="/preview/${file.filename}" type="video/mp4">
                       Your browser does not support the video tag.
                     </video>
                     <div class="video-overlay">
                       <span class="video-icon">üé¨</span>
                     </div>
                   </div>`
                : file.preview
                ? `<img src="data:image/jpeg;base64,${file.preview}" class="file-preview" alt="preview" onclick="openImageFullscreen(this.src)">`
                : '<div class="file-preview" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;">üìÑ</div>'
            }
            <div class="file-info">
              <div class="file-name">${file.original_name}</div>
              <div class="file-type">${file.type}</div>
            </div>
            <div class="file-actions">
              <button class="remove-btn" onclick="removeFile('source', ${
                file.id
              })">Remove</button>
              ${
                file.type === "video"
                  ? '<button class="play-btn" onclick="playVideo(this)">‚ñ∂Ô∏è Play</button>'
                  : ""
              }
            </div>
          </div>
        `
          )
          .join("");

        // Update target files display
        const targetList = document.getElementById("target-list");
        const targetCount = document.getElementById("target-count");
        targetCount.textContent = uploadedTargets.length;

        targetList.innerHTML = uploadedTargets
          .map(
            (file) => `
          <div class="file-item" data-file-id="${file.id}">
            ${
              file.type === "video"
                ? `<div class="file-preview video-preview-container" onclick="openVideoModal('/preview/${file.filename}')">
                     <video class="file-preview-video" muted preload="metadata">
                       <source src="/preview/${file.filename}" type="video/mp4">
                       Your browser does not support the video tag.
                     </video>
                     <div class="video-overlay">
                       <span class="video-icon">üé¨</span>
                     </div>
                   </div>`
                : file.preview
                ? `<img src="data:image/jpeg;base64,${file.preview}" class="file-preview" alt="preview" onclick="openImageFullscreen(this.src)">`
                : '<div class="file-preview" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;">üìÑ</div>'
            }
            <div class="file-info">
              <div class="file-name">${file.original_name}</div>
              <div class="file-type">${file.type}</div>
            </div>
            <div class="file-actions">
              <button class="remove-btn" onclick="removeFile('target', ${
                file.id
              })">Remove</button>
              ${
                file.type === "video"
                  ? '<button class="play-btn" onclick="playVideo(this)">‚ñ∂Ô∏è Play</button>'
                  : ""
              }
            </div>
          </div>
        `
          )
          .join("");
      }

      function removeFile(type, fileId) {
        fetch(`/files/${type}/${fileId}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              if (type === "source") {
                uploadedSources = uploadedSources.filter(
                  (f) => f.id !== fileId
                );
              } else {
                uploadedTargets = uploadedTargets.filter(
                  (f) => f.id !== fileId
                );
                // Re-check face enhancer setting after removing target files
                checkAndUpdateFaceEnhancer();
              }
              updateFileDisplay();
              updateProcessButton();
            }
          });
      }

      function clearTargetFiles() {
        // Clear all target files while keeping source files
        const targetIds = uploadedTargets.map((file) => file.id);

        Promise.all(
          targetIds.map((id) =>
            fetch(`/files/target/${id}`, { method: "DELETE" }).then(
              (response) => response.json()
            )
          )
        ).then((results) => {
          uploadedTargets = [];
          updateFileDisplay();
          updateProcessButton();

          // Reset face enhancer to default when targets are cleared
          const faceEnhancerCheckbox = document.getElementById("face_enhancer");
          if (!faceEnhancerCheckbox.checked) {
            faceEnhancerCheckbox.checked = true;
            updateSetting("face_enhancer", true);
          }

          // Clear target upload status
          document.getElementById("target-files").innerHTML = "";
        });
      }

      function clearSourceFiles() {
        // Clear all source files while keeping target files
        const sourceIds = uploadedSources.map((file) => file.id);

        Promise.all(
          sourceIds.map((id) =>
            fetch(`/files/source/${id}`, { method: "DELETE" }).then(
              (response) => response.json()
            )
          )
        ).then((results) => {
          uploadedSources = [];
          updateFileDisplay();
          updateProcessButton();

          // Clear source upload status
          document.getElementById("source-files").innerHTML = "";
        });
      }

      function clearAllFiles() {
        fetch("/clear-files", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              uploadedSources = [];
              uploadedTargets = [];
              updateFileDisplay();
              updateProcessButton();

              // Reset face enhancer to default when all files are cleared
              const faceEnhancerCheckbox =
                document.getElementById("face_enhancer");
              if (!faceEnhancerCheckbox.checked) {
                faceEnhancerCheckbox.checked = true;
                updateSetting("face_enhancer", true);
              }

              // Clear upload status
              document.getElementById("source-files").innerHTML = "";
              document.getElementById("target-files").innerHTML = "";
            }
          });
      }

      function updateSetting(setting, value) {
        fetch("/settings", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ [setting]: value }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              console.error("Failed to update setting");
            }
          });
      }

      function updateProcessButton() {
        const processBtn = document.getElementById("process-btn");
        if (uploadedSources.length > 0 && uploadedTargets.length > 0) {
          processBtn.disabled = false;
          processBtn.textContent = `Start Batch Processing (${
            uploadedTargets.length
          } file${uploadedTargets.length > 1 ? "s" : ""})`;
        } else {
          processBtn.disabled = true;
          processBtn.textContent = "Upload both source and target files";
        }
      }

      function checkAndUpdateFaceEnhancer() {
        // Check if any target files are videos
        const hasVideoTargets = uploadedTargets.some(
          (file) => file.type === "video"
        );

        if (hasVideoTargets) {
          // Disable face enhancer for video processing (performance optimization)
          const faceEnhancerCheckbox = document.getElementById("face_enhancer");
          if (faceEnhancerCheckbox.checked) {
            faceEnhancerCheckbox.checked = false;
            updateSetting("face_enhancer", false);

            // Show a brief notification
            const statusText = document.getElementById("status-text");
            const originalText = statusText.textContent;
            statusText.textContent =
              "Face enhancer disabled automatically for video processing (performance optimization)";
            statusText.style.color = "#faad14";

            setTimeout(() => {
              statusText.textContent = originalText;
              statusText.style.color = "";
            }, 3000);
          }
        }
      }

      function startProcessing() {
        const processBtn = document.getElementById("process-btn");
        processBtn.disabled = true;
        processBtn.textContent = "Processing...";

        // Reset results counter and clear previous results
        displayedResultsCount = 0;
        document.getElementById("batch-results").innerHTML = "";
        document.getElementById("result-section").style.display = "none";

        // Reset and show processing details
        const detailsSection = document.getElementById("processing-details");
        const detailsContent = document.getElementById("details-content");
        const toggle = document.getElementById("details-toggle");
        const header = document.querySelector(".details-header");

        detailsSection.style.display = "block";
        detailsContent.classList.add("expanded");
        header.classList.remove("collapsed");
        toggle.textContent = "‚ñº";

        // Clear previous logs
        updateDetailedLogs([]);

        fetch("/process", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              pollStatus();
            } else {
              document.getElementById("status-text").textContent = data.error;
              updateProcessButton();
            }
          })
          .catch((error) => {
            document.getElementById("status-text").textContent =
              "Error starting batch processing";
            updateProcessButton();
          });
      }

      let displayedResultsCount = 0;

      function pollStatus() {
        const statusInterval = setInterval(() => {
          fetch("/status")
            .then((response) => response.json())
            .then((data) => {
              document.getElementById("status-text").textContent = data.message;
              document.getElementById("progress-fill").style.width =
                data.progress + "%";

              // Update video progress information if available
              updateVideoProgress(data.video_progress);

              // Update detailed logs
              updateDetailedLogs(data.detailed_logs || []);

              // Show processing details section during processing
              const detailsSection =
                document.getElementById("processing-details");
              if (
                data.status === "processing" &&
                detailsSection.style.display === "none"
              ) {
                detailsSection.style.display = "block";
              }

              // Check for new results during processing
              if (data.status === "processing") {
                checkForNewResults();
              }

              if (data.status === "completed") {
                clearInterval(statusInterval);
                updateProcessButton();

                // Show any remaining results
                displayBatchResults(true);
              } else if (data.status === "error") {
                clearInterval(statusInterval);
                updateProcessButton();
                document.getElementById("result-section").style.display =
                  "none";
              }
            });
        }, 1000);
      }

      function updateDetailedLogs(logs) {
        const logContainer = document.getElementById("log-container");
        const logCount = document.getElementById("log-count");

        if (logs && logs.length > 0) {
          logContainer.innerHTML = logs
            .map((log) => {
              let className = "log-entry";

              // Add special styling based on log content
              const logLower = log.toLowerCase();
              if (logLower.includes("error") || logLower.includes("failed")) {
                className += " error";
              } else if (
                logLower.includes("completed") ||
                logLower.includes("success")
              ) {
                className += " success";
              } else if (
                logLower.includes("warning") ||
                logLower.includes("warn")
              ) {
                className += " warning";
              }

              return `<div class="${className}">${escapeHtml(log)}</div>`;
            })
            .join("");

          logCount.textContent = `(${logs.length} logs)`;

          // Auto-scroll to bottom
          const detailsContent = document.getElementById("details-content");
          if (detailsContent.classList.contains("expanded")) {
            logContainer.scrollTop = logContainer.scrollHeight;
          }
        } else {
          logContainer.innerHTML =
            '<div class="log-entry">Click "Start Processing" to see detailed logs...</div>';
          logCount.textContent = "(0 logs)";
        }
      }

      function toggleProcessingDetails() {
        const detailsContent = document.getElementById("details-content");
        const toggle = document.getElementById("details-toggle");
        const header = document.querySelector(".details-header");

        if (detailsContent.classList.contains("expanded")) {
          detailsContent.classList.remove("expanded");
          header.classList.add("collapsed");
          toggle.textContent = "‚ñ∂";
        } else {
          detailsContent.classList.add("expanded");
          header.classList.remove("collapsed");
          toggle.textContent = "‚ñº";

          // Auto-scroll to bottom when opening
          const logContainer = document.getElementById("log-container");
          setTimeout(() => {
            logContainer.scrollTop = logContainer.scrollHeight;
          }, 300);
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function updateVideoProgress(videoProgress) {
        const videoProgressInfo = document.getElementById(
          "video-progress-info"
        );
        const frameInfo = document.getElementById("frame-info");
        const timeInfo = document.getElementById("time-info");
        const speedInfo = document.getElementById("speed-info");

        if (videoProgress) {
          // Show video progress section
          videoProgressInfo.style.display = "block";

          // Update frame information
          frameInfo.textContent = `üìΩÔ∏è ${videoProgress.current_frame}/${videoProgress.total_frames} frames`;

          // Update time information
          timeInfo.textContent = `‚è±Ô∏è ${videoProgress.elapsed_time} < ${videoProgress.remaining_time}`;

          // Update speed and execution info
          const provider = videoProgress.execution_provider.includes("CUDA")
            ? "üöÄ GPU"
            : "üñ•Ô∏è CPU";
          speedInfo.textContent = `${provider} | ${videoProgress.frame_rate}`;
        } else {
          // Hide video progress section when not processing video
          videoProgressInfo.style.display = "none";
        }
      }

      function checkForNewResults() {
        fetch("/results")
          .then((response) => response.json())
          .then((data) => {
            if (data.results && data.results.length > displayedResultsCount) {
              displayBatchResults(false);
            }
          })
          .catch((error) => {
            console.error("Error checking for new results:", error);
          });
      }

      function displayBatchResults(isCompleted = false) {
        fetch("/results")
          .then((response) => response.json())
          .then((data) => {
            const resultSection = document.getElementById("result-section");
            const batchResults = document.getElementById("batch-results");

            if (data.results && data.results.length > 0) {
              // Show result section if not already visible
              if (resultSection.style.display === "none") {
                resultSection.style.display = "block";
              }

              // Only add new results that haven't been displayed yet
              const newResults = data.results.slice(displayedResultsCount);

              if (newResults.length > 0) {
                // Append new results to existing ones
                const newResultsHTML = newResults
                  .map((result, index) => {
                    const isVideo =
                      result.output_filename &&
                      (result.output_filename.toLowerCase().endsWith(".mp4") ||
                        result.output_filename.toLowerCase().endsWith(".avi") ||
                        result.output_filename.toLowerCase().endsWith(".mov") ||
                        result.output_filename.toLowerCase().endsWith(".mkv"));

                    return `
                  <div class="result-item" style="animation: fadeIn 0.5s ease-in;">
                    <div class="result-info">
                      <strong>Target:</strong> ${result.target}<br>
                      <strong>Source:</strong> ${result.source}
                    </div>
                    ${
                      isVideo
                        ? `<div class="result-preview">
                            <div class="video-preview-container result-video-container" onclick="openVideoModal('/preview/${result.output_filename}')">
                              <video class="result-video" muted preload="metadata">
                                <source src="/preview/${result.output_filename}" type="video/mp4">
                                Your browser does not support the video tag.
                              </video>
                              <div class="video-play-overlay">
                                <span class="video-play-icon">‚ñ∂Ô∏è</span>
                              </div>
                            </div>
                          </div>`
                        : result.preview
                        ? `<div class="result-preview">
                              <img src="data:image/jpeg;base64,${
                                result.preview
                              }" 
                                   class="result-image" 
                                   alt="Result ${
                                     displayedResultsCount + index + 1
                                   }"
                                   onclick="openImageFullscreen(this.src)"
                                   title="Click to view full size">
                            </div>`
                        : '<div class="result-preview">Processing completed</div>'
                    }
                    <button class="download-individual" onclick="downloadIndividualResult('${
                      result.output_filename
                    }')">
                      Download
                    </button>
                    ${
                      isVideo
                        ? '<button class="play-result-btn" onclick="playResultVideo(this)">üé¨ Play Video</button>'
                        : ""
                    }
                  </div>`;
                  })
                  .join("");

                batchResults.innerHTML += newResultsHTML;
                displayedResultsCount = data.results.length;
              }
            }
          })
          .catch((error) => {
            console.error("Error fetching results:", error);
          });
      }

      function downloadIndividualResult(filename) {
        window.location.href = `/preview/${filename}`;
      }

      function downloadAllResults() {
        // Download all results as a single ZIP file
        window.location.href = "/download-all";
      }

      function openImageFullscreen(imageSrc) {
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        modal.style.display = "block";
        modalImg.src = imageSrc;

        // Prevent event bubbling
        event.stopPropagation();
      }

      function closeImageModal() {
        document.getElementById("imageModal").style.display = "none";
      }

      function playVideo(button) {
        // Find the video element in the same file item
        const fileItem = button.closest(".file-item");
        const video = fileItem.querySelector("video");
        if (video) {
          openVideoModal(video.querySelector("source").src);
        }
      }

      function playResultVideo(button) {
        // Find the video element in the same result item
        const resultItem = button.closest(".result-item");
        const video = resultItem.querySelector("video");
        if (video) {
          openVideoModal(video.querySelector("source").src);
        }
      }

      function openVideoModal(videoSrc) {
        const modal = document.getElementById("videoModal");
        const modalVideo = document.getElementById("modalVideo");
        const modalVideoSource = document.getElementById("modalVideoSource");

        modalVideoSource.src = videoSrc;
        modalVideo.load(); // Reload the video with new source
        modal.style.display = "block";

        // Prevent event bubbling
        event.stopPropagation();
      }

      function closeVideoModal() {
        const modal = document.getElementById("videoModal");
        const modalVideo = document.getElementById("modalVideo");
        modal.style.display = "none";
        modalVideo.pause();
        modalVideo.currentTime = 0;
      }

      // Close modal with Escape key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeImageModal();
          closeVideoModal();
        }
      });

      // Drag and drop functionality
      document.addEventListener("DOMContentLoaded", function () {
        const uploadBoxes = document.querySelectorAll(".upload-box");

        uploadBoxes.forEach((box) => {
          box.addEventListener("dragover", function (e) {
            e.preventDefault();
            this.classList.add("dragover");
          });

          box.addEventListener("dragleave", function (e) {
            e.preventDefault();
            this.classList.remove("dragover");
          });

          box.addEventListener("drop", function (e) {
            e.preventDefault();
            this.classList.remove("dragover");

            const files = e.dataTransfer.files;
            if (files.length > 0) {
              const input = this.querySelector('input[type="file"]');
              input.files = files;
              const type = input.id.includes("source") ? "source" : "target";
              uploadFiles(input, type);
            }
          });
        });
      });

      // Load existing files on page load
      function loadExistingFiles() {
        fetch("/files")
          .then((response) => response.json())
          .then((data) => {
            uploadedSources = data.sources || [];
            uploadedTargets = data.targets || [];
            updateFileDisplay();
            updateProcessButton();
            // Check face enhancer setting for any existing video targets
            checkAndUpdateFaceEnhancer();
          })
          .catch((error) => {
            console.error("Error loading existing files:", error);
          });
      }

      // Initialize face enhancer setting on page load
      function initializeSettings() {
        const faceEnhancerCheckbox = document.getElementById("face_enhancer");
        if (faceEnhancerCheckbox.checked) {
          updateSetting("face_enhancer", true);
        }
      }

      // Initialize
      loadExistingFiles();
      initializeSettings();
    </script>
  </body>
</html>
